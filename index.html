<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APEX Wheel ‚Äî Modern Max</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a1929;
      --panel: #0f2438;
      --card: #132f44;
      --accent: #4fc4f7;
      --muted: #a6b3c5;
      --glass: rgba(255,255,255,0.05);
      --gradient-start: #4fc4f7;
      --gradient-mid: #7c4dff;
      --gradient-end: #ff6ec4;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Press Start 2P", monospace;
      background: linear-gradient(180deg, var(--bg) 0%, #081221 100%);
      color: #e6eef6;
    }
    
    .app {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 18px;
      padding: 18px;
      min-height: 100vh;
      max-width: 1300px;
      margin: 0 auto;
    }
    
    @media (max-width: 980px) {
      .app {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      .panel {
        height: auto;
      }
    }
    
    .stage {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 18px;
      border-radius: 16px;
      background: linear-gradient(145deg, #0c1e30, #0a1929);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }
    
    .stage::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
      z-index: 10;
    }
    
    canvas#wheel {
      width: min(760px, 88vw);
      height: auto;
      border-radius: 12px;
      image-rendering: pixelated;
      background: transparent;
    }
    
    .pointer {
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: 92px;
      height: 120px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      pointer-events: none;
      z-index: 40;
    }
    
    .pointer .head {
      margin-top: 2px;
      width: 40px;
      height: 40px;
      background: #0a1a2a;
      border-radius: 8px;
      border: 3px solid var(--accent);
      display: grid;
      place-items: center;
      font-size: 14px;
      box-shadow: 0 0 15px rgba(79, 196, 247, 0.5);
    }
    
    .overlay-result {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, rgba(15, 36, 56, 0.95), rgba(19, 47, 68, 0.98));
      padding: 24px;
      border-radius: 16px;
      backdrop-filter: blur(10px);
      display: none;
      z-index: 50;
      min-width: 280px;
      text-align: center;
      border: 1px solid rgba(79, 196, 247, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
    }
    
    .overlay-result.show {
      display: block;
      animation: pop 0.36s ease-out;
    }
    
    @keyframes pop {
      from {
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }
    
    aside.panel {
      padding: 20px;
      border-radius: 16px;
      background: linear-gradient(145deg, #0f2438, #0d2032);
      height: calc(100vh - 36px);
      overflow: auto;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    h1 {
      font-size: 14px;
      margin: 0 0 8px 0;
    }
    
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-top: 16px;
    }
    
    textarea, input, select, button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(15, 36, 56, 0.6);
      color: inherit;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(79, 196, 247, 0.2);
    }
    
    .row {
      display: flex;
      gap: 8px;
    }
    
    .btn {
      background: linear-gradient(145deg, #1a3a5a, #15304c);
      border: 1px solid rgba(79, 196, 247, 0.2);
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 10px;
      color: #e6f4fb;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
      background: linear-gradient(145deg, #1f4265, #183656);
      border-color: rgba(79, 196, 247, 0.4);
    }
    
    .small {
      padding: 8px;
      font-size: 12px;
    }
    
    .muted {
      color: var(--muted);
      font-size: 12px;
    }
    
    .chip {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 8px;
      background: linear-gradient(145deg, #1a3a5a, #15304c);
      margin: 4px 4px 0 0;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .winners {
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      background: linear-gradient(145deg, rgba(15, 36, 56, 0.6), rgba(19, 47, 68, 0.7));
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .winner {
      font-weight: 700;
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .footer {
      font-size: 11px;
      color: var(--muted);
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .range {
      appearance: none;
      height: 8px;
      border-radius: 8px;
      background: linear-gradient(90deg, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
      outline: none;
    }
    
    .range::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(79, 196, 247, 0.8);
    }
    
    .tiny {
      font-size: 12px;
      padding: 8px;
    }
    
    .switch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    nav.simple {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .theme-toggle {
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.2s;
    }
    
    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .posts {
      margin-top: 16px;
    }
    
    .post {
      padding: 12px;
      border-radius: 10px;
      background: linear-gradient(145deg, rgba(15, 36, 56, 0.6), rgba(19, 47, 68, 0.7));
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .pixel-mode * {
      image-rendering: pixelated;
    }
    
    /* accessibility focus */
    [tabindex]:focus {
      outline: 2px solid rgba(79, 196, 247, 0.4);
      outline-offset: 3px;
    }
    
    .language-selector {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .lang-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }
    
    .lang-btn.active {
      background: linear-gradient(145deg, var(--gradient-start), var(--gradient-mid));
      color: white;
      box-shadow: 0 4px 12px rgba(79, 196, 247, 0.3);
    }
    
    .lang-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="stage" id="stage">
      <div class="pointer" aria-hidden="true">
        <div class="head">‚ô°</div>
      </div>

      <canvas id="wheel" width="1200" height="1200" role="img" aria-label="Lucky wheel" tabindex="0"></canvas>

      <div style="position:absolute;bottom:18px;display:flex;gap:8px;left:50%;transform:translateX(-50%);z-index:30;">
        <button id="spinBtn" class="btn small" data-i18n="spin">QUAY</button>
        <button id="pickOne" class="btn small" data-i18n="pickOne">CH·ªåN 1</button>
        <button id="pickMany" class="btn small" data-i18n="pickMany">CH·ªåN NHI·ªÄU</button>
        <button id="exportPNG" class="btn small" data-i18n="exportPNG">XU·∫§T PNG</button>
      </div>

      <div id="resultOverlay" class="overlay-result" role="status" aria-live="polite">
        <div id="overlayText" style="font-weight:800;font-size:18px;margin-bottom:12px"></div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button id="overlayClose" class="btn tiny" data-i18n="close">ƒê√≥ng</button>
          <button id="overlayAddPost" class="btn tiny" data-i18n="saveAsPost">L∆∞u b√†i ƒëƒÉng</button>
        </div>
      </div>
    </div>

    <aside class="panel" aria-label="Wheel controls">
      <nav class="simple" aria-hidden="false">
        <div class="muted" data-i18n="appTitle">APEX ‚Äî B√°nh xe may m·∫Øn</div>
        <div style="flex:1"></div>
        <div class="theme-toggle" id="themeToggle" title="Toggle theme / pixel mode">üåì</div>
      </nav>

      <div class="language-selector">
        <div class="lang-btn active" data-lang="vi">Ti·∫øng Vi·ªát</div>
        <div class="lang-btn" data-lang="en">English</div>
      </div>

      <label for="namesInput" data-i18n="namesLabel">T√™n (m·ªói d√≤ng m·ªôt t√™n ‚Äî h·ªó tr·ª£ tr·ªçng s·ªë)</label>
      <textarea id="namesInput" rows="8" placeholder="Nguy·ªÖn VƒÉn A&#10;Tr·∫ßn Th·ªã B;2&#10;L√™ VƒÉn C|3&#10;Ph·∫°m Th·ªã D"></textarea>

      <div class="row">
        <button id="parseBtn" class="btn small" data-i18n="parse">Ph√¢n t√≠ch</button>
        <button id="clearBtn" class="btn small" data-i18n="clear">X√≥a</button>
        <button id="loadSample" class="btn small" data-i18n="loadSample">M·∫´u</button>
      </div>

      <label data-i18n="optionsLabel">T√πy ch·ªçn</label>
      <div class="controls-grid" style="margin-top:6px">
        <label class="muted"><input type="checkbox" id="removeDuplicates"> <span data-i18n="removeDuplicates">X√≥a tr√πng l·∫∑p</span></label>
        <label class="muted"><input type="checkbox" id="removeOnPick" checked> <span data-i18n="removeAfterPick">X√≥a sau khi ch·ªçn</span></label>
      </div>

      <label for="pickCount" data-i18n="pickCountLabel">S·ªë l∆∞·ª£ng ch·ªçn (cho CH·ªåN NHI·ªÄU)</label>
      <input id="pickCount" type="number" min="1" value="3">

      <label for="spinPower" data-i18n="spinStrengthLabel">L·ª±c quay</label>
      <input id="spinPower" type="range" min="0.5" max="6" step="0.1" value="2" class="range">

      <label for="seed" data-i18n="seedLabel">H·∫°t gi·ªëng (ƒë·ªÉ tr·ªëng cho ng·∫´u nhi√™n)</label>
      <input id="seed" type="text" placeholder="h·∫°t gi·ªëng t√πy ch·ªçn ƒë·ªÉ quay c√≥ th·ªÉ t√°i l·∫≠p" data-i18n-ph="seedPlaceholder">

      <div style="display:flex;gap:8px;margin-top:16px;">
        <button id="saveList" class="btn small" data-i18n="saveList">L∆∞u danh s√°ch</button>
        <button id="loadList" class="btn small" data-i18n="loadList">T·∫£i danh s√°ch</button>
        <button id="shareBtn" class="btn small" data-i18n="shareBtn">Chia s·∫ª (sao ch√©p URL)</button>
      </div>

      <label data-i18n="namesPreviewLabel">Xem tr∆∞·ªõc t√™n</label>
      <div id="namesPreview" style="max-height:120px;overflow:auto;padding:8px;border-radius:8px;background:rgba(15, 36, 56, 0.6);margin-top:8px;"></div>

      <label data-i18n="winnersHistoryLabel">Ng∆∞·ªùi chi·∫øn th·∫Øng & l·ªãch s·ª≠</label>
      <div id="winners" class="winners"></div>

      <label style="margin-top:16px" data-i18n="postsLabel">B√†i ƒëƒÉng (k·∫øt qu·∫£ quay)</label>
      <div id="posts" class="posts"></div>

      <div style="display:flex;gap:8px;margin-top:16px;">
        <button id="clearHistory" class="btn small" data-i18n="clearWinners">X√≥a ng∆∞·ªùi th·∫Øng</button>
        <button id="undoRemove" class="btn small" data-i18n="undoRemove">Ho√†n t√°c x√≥a</button>
        <label style="flex:1" class="muted"><span data-i18n="soundLabel">√Çm thanh:</span> <input type="checkbox" id="soundToggle" checked></label>
      </div>

      <div class="footer" data-i18n="footerText">Ph√≠m t·∫Øt: <strong>Space</strong> = quay, <strong>Ctrl/Cmd+Enter</strong> = Ph√¢n t√≠ch. Ho·∫°t ƒë·ªông ngo·∫°i tuy·∫øn, l∆∞u tr·ªØ trong localStorage.</div>
    </aside>
  </div>

  <script>
  (function(){
    // B·∫£ng m√†u m·ªõi h√†i h√≤a h∆°n
    const colors = [
      "#4fc4f7", // Xanh s√°ng
      "#7c4dff", // T√≠m
      "#ff6ec4", // H·ªìng
      "#4dd0e1", // Xanh ng·ªçc
      "#aed581", // Xanh l√° nh·∫°t
      "#ff8a65", // Cam
      "#9575cd", // T√≠m nh·∫°t
      "#64ffda", // Xanh l√° m·∫°
      "#ffb74d", // V√†ng cam
      "#7986cb", // Xanh lam nh·∫°t
      "#f06292", // H·ªìng ƒë·∫≠m
      "#4db6ac"  // Xanh l·ª•c lam
    ];

    // elements
    const canvas = document.getElementById('wheel'), ctx = canvas.getContext('2d');
    const namesInput = document.getElementById('namesInput'), parseBtn = document.getElementById('parseBtn'), clearBtn = document.getElementById('clearBtn'), loadSample = document.getElementById('loadSample');
    const namesPreview = document.getElementById('namesPreview'), spinBtn = document.getElementById('spinBtn'), pickOne = document.getElementById('pickOne'), pickMany = document.getElementById('pickMany');
    const pickCount = document.getElementById('pickCount'), removeDuplicates = document.getElementById('removeDuplicates'), removeOnPick = document.getElementById('removeOnPick');
    const seedInput = document.getElementById('seed'), saveList = document.getElementById('saveList'), loadList = document.getElementById('loadList'), shareBtn = document.getElementById('shareBtn');
    const winnersDiv = document.getElementById('winners'), exportPNG = document.getElementById('exportPNG'), spinPower = document.getElementById('spinPower');
    const resultOverlay = document.getElementById('resultOverlay'), overlayText = document.getElementById('overlayText'), overlayClose = document.getElementById('overlayClose'), overlayAddPost = document.getElementById('overlayAddPost');
    const postsDiv = document.getElementById('posts'), clearHistoryBtn = document.getElementById('clearHistory'), undoRemoveBtn = document.getElementById('undoRemove'), soundToggle = document.getElementById('soundToggle');
    const themeToggle = document.getElementById('themeToggle');
    const langButtons = document.querySelectorAll('.lang-btn');

    // state
    let items = []; // {label, weight, color, id}
    let removedStack = [];
    let winners = [];
    let posts = [];
    let state = {angle:0, angularVelocity:0, spinning:false, lastTick:-1, size:1200, idle:true};
    let pixelMode = false, darkTheme = true;
    let currentLang = 'vi'; // M·∫∑c ƒë·ªãnh l√† ti·∫øng Vi·ªát

    // H√†m ƒëa ng√¥n ng·ªØ
    const i18n = {
      vi: {
        appTitle: "APEX ‚Äî B√°nh xe may m·∫Øn",
        spin: "QUAY",
        pickOne: "CH·ªåN 1",
        pickMany: "CH·ªåN NHI·ªÄU",
        exportPNG: "XU·∫§T PNG",
        close: "ƒê√≥ng",
        saveAsPost: "L∆∞u b√†i ƒëƒÉng",
        namesLabel: "T√™n (m·ªói d√≤ng m·ªôt t√™n ‚Äî h·ªó tr·ª£ tr·ªçng s·ªë)",
        parse: "Ph√¢n t√≠ch",
        clear: "X√≥a",
        loadSample: "M·∫´u",
        optionsLabel: "T√πy ch·ªçn",
        removeDuplicates: "X√≥a tr√πng l·∫∑p",
        removeAfterPick: "X√≥a sau khi ch·ªçn",
        pickCountLabel: "S·ªë l∆∞·ª£ng ch·ªçn (cho CH·ªåN NHI·ªÄU)",
        spinStrengthLabel: "L·ª±c quay",
        seedLabel: "H·∫°t gi·ªëng (ƒë·ªÉ tr·ªëng cho ng·∫´u nhi√™n)",
        seedPlaceholder: "h·∫°t gi·ªëng t√πy ch·ªçn ƒë·ªÉ quay c√≥ th·ªÉ t√°i l·∫≠p",
        saveList: "L∆∞u danh s√°ch",
        loadList: "T·∫£i danh s√°ch",
        shareBtn: "Chia s·∫ª (sao ch√©p URL)",
        namesPreviewLabel: "Xem tr∆∞·ªõc t√™n",
        winnersHistoryLabel: "Ng∆∞·ªùi chi·∫øn th·∫Øng & l·ªãch s·ª≠",
        postsLabel: "B√†i ƒëƒÉng (k·∫øt qu·∫£ quay)",
        clearWinners: "X√≥a ng∆∞·ªùi th·∫Øng",
        undoRemove: "Ho√†n t√°c x√≥a",
        soundLabel: "√Çm thanh:",
        footerText: "Ph√≠m t·∫Øt: <strong>Space</strong> = quay, <strong>Ctrl/Cmd+Enter</strong> = Ph√¢n t√≠ch. Ho·∫°t ƒë·ªông ngo·∫°i tuy·∫øn, l∆∞u tr·ªØ trong localStorage.",
        enterListName: "Nh·∫≠p t√™n danh s√°ch",
        saved: "ƒê√£ l∆∞u",
        noSaved: "Ch∆∞a c√≥ danh s√°ch l∆∞u",
        loadListPrompt: "Ch·ªçn danh s√°ch ƒë·ªÉ n·∫°p",
        urlCopied: "ƒê√£ sao ch√©p URL",
        shareFail: "Chia s·∫ª th·∫•t b·∫°i",
        noNames: "Ch∆∞a c√≥ t√™n ‚Äî h√£y d√°n t√™n tr∆∞·ªõc",
        winnerPrefix: "Ng∆∞·ªùi th·∫Øng:",
        spinResult: "K·∫øt qu·∫£ quay",
        postSaved: "ƒê√£ l∆∞u b√†i",
        confirmClearWinners: "X√≥a l·ªãch s·ª≠ ng∆∞·ªùi th·∫Øng?",
        nothingToUndo: "Kh√¥ng c√≥ g√¨ ƒë·ªÉ ho√†n t√°c"
      },
      en: {
        appTitle: "APEX ‚Äî Wheel of Names",
        spin: "SPIN",
        pickOne: "PICK 1",
        pickMany: "PICK MANY",
        exportPNG: "EXPORT PNG",
        close: "Close",
        saveAsPost: "Save as Post",
        namesLabel: "Names (one per line ‚Äî supports weight)",
        parse: "Parse",
        clear: "Clear",
        loadSample: "Sample",
        optionsLabel: "Options",
        removeDuplicates: "Remove duplicates",
        removeAfterPick: "Remove after pick",
        pickCountLabel: "Pick count (for PICK MANY)",
        spinStrengthLabel: "Spin strength",
        seedLabel: "Seed (leave empty for random)",
        seedPlaceholder: "optional seed for reproducible spins",
        saveList: "Save List",
        loadList: "Load List",
        shareBtn: "Share (copy URL)",
        namesPreviewLabel: "Names preview",
        winnersHistoryLabel: "Winners & history",
        postsLabel: "Posts (spin results)",
        clearWinners: "Clear Winners",
        undoRemove: "Undo Remove",
        soundLabel: "Sound:",
        footerText: "Shortcuts: <strong>Space</strong> = spin, <strong>Ctrl/Cmd+Enter</strong> = Parse. Works offline, stores in localStorage.",
        enterListName: "Enter list name",
        saved: "Saved",
        noSaved: "No saved lists",
        loadListPrompt: "Load list name",
        urlCopied: "URL copied to clipboard",
        shareFail: "Share failed",
        noNames: "No names ‚Äî paste some names first",
        winnerPrefix: "Winner:",
        spinResult: "Spin result",
        postSaved: "Post saved",
        confirmClearWinners: "Clear winners history?",
        nothingToUndo: "Nothing to undo"
      }
    };

    // H√†m c·∫≠p nh·∫≠t ng√¥n ng·ªØ
    function updateLanguage(lang) {
      currentLang = lang;
      
      // C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ thu·ªôc t√≠nh data-i18n
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang][key]) {
          el.textContent = i18n[lang][key];
        }
      });
      
      // C·∫≠p nh·∫≠t placeholder
      document.querySelectorAll('[data-i18n-ph]').forEach(el => {
        const key = el.getAttribute('data-i18n-ph');
        if (i18n[lang][key]) {
          el.placeholder = i18n[lang][key];
        }
      });
      
      // C·∫≠p nh·∫≠t n√∫t ng√¥n ng·ªØ active
      langButtons.forEach(btn => {
        if (btn.getAttribute('data-lang') === lang) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      // V·∫Ω l·∫°i b√°nh xe ƒë·ªÉ c·∫≠p nh·∫≠t text
      draw();
    }

    // S·ª± ki·ªán ch·ªçn ng√¥n ng·ªØ
    langButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-lang');
        updateLanguage(lang);
      });
    });

    // RNG
    function mulberry32(a){return function(){let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296;}}
    function hashStringToInt(s){let h=2166136261; for(let i=0;i<s.length;i++){h ^= s.charCodeAt(i); h = Math.imul(h, 16777619);}return h>>>0}

    // palette
    function pickColor(i){ return colors[i % colors.length]; }

    function cryptoRandomId(){ return Math.random().toString(36).slice(2,9); }

    // parse
    function parseNames(){
      const raw = namesInput.value.split('\n').map(r=>r.trim()).filter(Boolean);
      const set = new Map(); const arr = [];
      for(let line of raw){
        let name = line; let weight = 1;
        const m = line.match(/^(.+?)[;|,](\s*\d+(?:\.\d+)?)$/);
        if(m){ name = m[1].trim(); weight = parseFloat(m[2]); }
        if(removeDuplicates.checked){ if(set.has(name)) continue; set.set(name,true); }
        arr.push({label:name, weight: isNaN(weight)?1:weight, color: pickColor(arr.length), id: cryptoRandomId()});
      }
      items = arr; buildPreview(); saveTemp(); draw();
    }

    parseBtn.addEventListener('click', parseNames);
    clearBtn.addEventListener('click', ()=>{ namesInput.value=''; items=[]; buildPreview(); saveTemp(); draw(); });
    loadSample.addEventListener('click', ()=>{ 
      if (currentLang === 'vi') {
        namesInput.value = 'Nguy·ªÖn VƒÉn A\nTr·∫ßn Th·ªã B;2\nL√™ VƒÉn C|3\nPh·∫°m Th·ªã D\nHo√†ng VƒÉn E\nƒê·ªó Th·ªã F;0.5'; 
      } else {
        namesInput.value = 'Alice\nBob;2\nCharlie|3\nDavid\nEve\nFrank;0.5'; 
      }
      parseNames(); 
    });

    function buildPreview(){ 
      namesPreview.innerHTML=''; 
      for(const it of items){ 
        const el = document.createElement('div'); 
        el.className='chip'; 
        el.textContent = it.label + (it.weight!==1?(' √ó'+it.weight):''); 
        el.style.background = it.color; 
        namesPreview.appendChild(el); 
      } 
    }

    // persistence
    function saveTemp(){ localStorage.setItem('apex_names_temp', JSON.stringify(items)); }
    function loadTemp(){ const raw = localStorage.getItem('apex_names_temp'); if(raw){ try{ items = JSON.parse(raw); buildPreview(); }catch(e){} } }
    function saveWinners(){ localStorage.setItem('apex_winners', JSON.stringify(winners)); }
    function loadWinners(){ const raw = localStorage.getItem('apex_winners'); if(raw){ try{ winners = JSON.parse(raw); }catch(e){} } renderWinners(); }
    function savePosts(){ localStorage.setItem('apex_posts', JSON.stringify(posts)); }
    function loadPosts(){ const raw = localStorage.getItem('apex_posts'); if(raw){ try{ posts = JSON.parse(raw); }catch(e){} } renderPosts(); }

    saveList.addEventListener('click', ()=>{ const name = prompt(i18n[currentLang]['enterListName']); if(!name) return; const lists = JSON.parse(localStorage.getItem('apex_saved_lists')||'{}'); lists[name]=items; localStorage.setItem('apex_saved_lists', JSON.stringify(lists)); alert(i18n[currentLang]['saved']); });
    loadList.addEventListener('click', ()=>{ const lists = JSON.parse(localStorage.getItem('apex_saved_lists')||'{}'); const keys = Object.keys(lists); if(keys.length===0){alert(i18n[currentLang]['noSaved']);return} const pick = prompt(i18n[currentLang]['loadListPrompt'] + '\n' + keys.join('\n'), keys[0]); if(pick && lists[pick]){ items = lists[pick]; namesInput.value = items.map(i=> i.label + (i.weight && i.weight!==1 ? ';'+i.weight : '')).join('\n'); buildPreview(); saveTemp(); }});

    function makeShareURL(){ try{ const payload = JSON.stringify(items); const b = btoa(unescape(encodeURIComponent(payload))); const url = location.origin + location.pathname + '#data=' + b; copyTextToClipboard(url); alert(i18n[currentLang]['urlCopied']); }catch(e){ alert(i18n[currentLang]['shareFail']); } }
    shareBtn.addEventListener('click', makeShareURL);

    function loadFromHash(){ if(location.hash.startsWith('#data=')){ try{ const b = location.hash.slice(6); const txt = decodeURIComponent(escape(atob(b))); const j = JSON.parse(txt); if(Array.isArray(j)){ items = j; namesInput.value = items.map(i=> i.label + (i.weight && i.weight!==1 ? ';'+i.weight : '')).join('\n'); buildPreview(); } }catch(e){} } }
    loadFromHash();

    function copyTextToClipboard(s){ navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(s) : (function(){const t=document.createElement('textarea'); t.value=s; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); })(); }

    // weighted pick
    function weightedPick(rngFn){ const total = items.reduce((s,it)=> s + (Number(it.weight)||1),0); if(total<=0) return null; let x = (typeof rngFn === 'function' ? rngFn() : Math.random())*total; for(const it of items){ x -= (Number(it.weight)||1); if(x<=0) return it; } return items[items.length-1]; }

    // spinning
    function startSpin(seed=null, power=2, onResult){
      if(items.length===0) { alert(i18n[currentLang]['noNames']); return; }
      if(state.spinning) return;
      state.spinning = true; state.idle=false;
      let rng = Math.random; if(seed){ rng = mulberry32(hashStringToInt(seed)); }
      const chosen = weightedPick(seed? rng : Math.random);
      const targetIndex = items.findIndex(it => it.id === chosen.id);
      const n = items.length; const sector = 2*Math.PI/n;
      const targetCenter = (Math.PI*1.5) - (targetIndex*sector) - sector/2;
      const extraRot = 3 + Math.floor(rng()*6);
      const desiredAngle = targetCenter + extraRot*2*Math.PI + (rng()-0.5)*sector*0.5;
      const delta = desiredAngle - state.angle;
      state.angularVelocity = Math.sign(delta) * Math.max(0.6, Math.sqrt(Math.abs(delta))*0.9 * power);
      state._onResult = onResult || function(){ displayWinner(chosen); };
    }

    // display winner UI
    function displayWinner(item){
      // overlay
      overlayText.textContent = i18n[currentLang]['winnerPrefix'] + ' ' + item.label;
      resultOverlay.classList.add('show');
      // winners list
      winners.unshift({id:item.id,label:item.label,ts:Date.now()});
      renderWinners();
      if(removeOnPick.checked){
        removedStack.push(item);
        items = items.filter(i=> i.id !== item.id);
        namesInput.value = items.map(i=> i.label + (i.weight && i.weight!==1 ? ';'+i.weight : '')).join('\n');
        buildPreview(); saveTemp();
      }
      saveWinners();
      posts.unshift({type:'spin', title:`${i18n[currentLang]['spinResult']}: ${item.label}`, ts:Date.now()});
      savePosts(); renderPosts();
    }

    overlayClose.addEventListener('click', ()=> resultOverlay.classList.remove('show'));
    overlayAddPost.addEventListener('click', ()=>{ const txt = overlayText.textContent || ''; posts.unshift({type:'post', title:txt, ts:Date.now()}); savePosts(); renderPosts(); alert(i18n[currentLang]['postSaved']); });

    // main tick loop
    let last = performance.now();
    function tick(now){
      const dt = Math.min(40, now-last)/1000; last = now;
      if(!state.spinning){ state.angle += 0.0006 * (dt*60); } else {
        state.angle += state.angularVelocity * dt;
        const friction = 0.988;
        state.angularVelocity *= Math.pow(friction, dt*60);
        if(Math.abs(state.angularVelocity) < 0.002){
          state.spinning=false; state.angularVelocity=0;
          const n = items.length; const sector = 2*Math.PI/n;
          let rot = (Math.PI*1.5 - state.angle) % (2*Math.PI); if(rot<0) rot += 2*Math.PI;
          const idx = Math.floor(rot/sector) % n; const winner = items[idx];
          spawnConfetti(canvas.width/2, canvas.height/3); playTick(320,0.06,0.14);
          if(winner && state._onResult) state._onResult(winner);
        } else {
          // tick sound on sector crossing
          const n = items.length; const sector = 2*Math.PI/n; let rot = (state.angle) % (2*Math.PI); if(rot<0) rot += 2*Math.PI;
          const pointerAngle = (Math.PI*1.5 - rot + 2*Math.PI) % (2*Math.PI);
          let idx = Math.floor(pointerAngle/sector);
          if(idx !== state.lastTick){ state.lastTick = idx; playTick(180 + (idx%6)*20, 0.02, 0.04); }
        }
      }
      updateConfetti(dt); draw(); requestAnimationFrame(tick);
    }

    requestAnimationFrame(tick);

    // audio
    const AudioCtx = window.AudioContext || window.webkitAudioContext; const audioCtx = AudioCtx ? new AudioCtx() : null;
    function playTick(f=140,dur=0.02,vol=0.06){ if(!audioCtx || !soundToggle.checked) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='square'; o.frequency.value=f; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+dur); o.stop(audioCtx.currentTime+dur+0.02); }
    // small beep for result
    function playWin(){ if(!audioCtx || !soundToggle.checked) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.value=560; g.gain.value=0.05; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.5); o.stop(audioCtx.currentTime+0.52); }

    // confetti
    const confetti = {items:[]};
    function spawnConfetti(x,y){ for(let i=0;i<80;i++){ confetti.items.push({x:x + (Math.random()-0.5)*400, y:y + (Math.random()-0.5)*120, vx:(Math.random()-0.5)*12, vy:(Math.random()*-12)-2, size:2+Math.random()*6, color:colors[Math.floor(Math.random()*colors.length)]}); } playWin(); }
    function updateConfetti(dt){ for(let i=confetti.items.length-1;i>=0;i--){ const p = confetti.items[i]; p.vy += 0.32; p.x += p.vx; p.y += p.vy; p.vx *= 0.998; if(p.y > canvas.height + 120) confetti.items.splice(i,1); } }
    function drawConfetti(){ for(const p of confetti.items){ ctx.fillStyle = p.color; ctx.fillRect(Math.floor(p.x), Math.floor(p.y), Math.ceil(p.size), Math.ceil(p.size)); } }

    // draw wheel - Updated to use the new color scheme and improved text rendering
    function draw(){
      const w = canvas.width, h = canvas.height; ctx.clearRect(0,0,w,h); 
      ctx.fillStyle='#0a1929'; 
      ctx.fillRect(0,0,w,h);
      const cx = w/2, cy = h/2, radius = Math.min(w,h)*0.42; 
      const n = Math.max(1, items.length); 
      const sector = 2*Math.PI/n;
      
      // Draw wheel shadow
      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctx.shadowBlur = 15;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 5;
      
      for(let r=radius+6;r>radius+2;r--){ 
        ctx.beginPath(); 
        ctx.arc(cx,cy,r,0,Math.PI*2); 
        ctx.fillStyle='rgba(0,0,0,0.1)'; 
        ctx.fill(); 
      }
      
      ctx.shadowBlur = 0;
      ctx.shadowOffsetY = 0;
      
      // Draw segments
      for(let i=0;i<n;i++){
        const a0 = state.angle + i*sector; 
        const a1 = a0 + sector;
        ctx.beginPath(); 
        ctx.moveTo(cx,cy); 
        ctx.arc(cx,cy,radius,a0,a1); 
        ctx.closePath();
        ctx.fillStyle = items[i] ? items[i].color : '#4a5568'; 
        ctx.fill();
        ctx.strokeStyle='rgba(0,0,0,0.15)'; 
        ctx.lineWidth=6; 
        ctx.stroke();
        
        if(items[i]){
          ctx.save();
          const mid = (a0+a1)/2;
          ctx.translate(cx + Math.cos(mid)*(radius*0.65), cy + Math.sin(mid)*(radius*0.65));
          ctx.rotate(mid+Math.PI/2);
          
          // Improved text rendering with better contrast
          ctx.font = 'bold ' + Math.floor(radius*0.05) + 'px "Press Start 2P", monospace';
          ctx.textAlign='center'; 
          ctx.textBaseline='middle';
          
          // Calculate text color based on background brightness for better contrast
          const bgColor = items[i].color;
          const rgb = parseInt(bgColor.slice(1), 16);
          const r = (rgb >> 16) & 0xff;
          const g = (rgb >> 8) & 0xff;
          const b = (rgb >> 0) & 0xff;
          const brightness = (r * 299 + g * 587 + b * 114) / 1000;
          ctx.fillStyle = brightness > 160 ? '#1a202c' : '#ffffff';
          
          wrapText(ctx, items[i].label, 0, 0, radius*0.56, Math.floor(radius*0.045));
          ctx.restore();
        }
      }
      
      // Center badge
      ctx.beginPath(); 
      ctx.arc(cx,cy,radius*0.22,0,Math.PI*2); 
      ctx.fillStyle='#132f44'; 
      ctx.fill(); 
      ctx.lineWidth=6; 
      ctx.strokeStyle='rgba(255,255,255,0.05)'; 
      ctx.stroke();
      
      ctx.fillStyle='#e6f4fb'; 
      ctx.font = 'bold ' + Math.floor(radius*0.06) + 'px "Press Start 2P", monospace'; 
      ctx.textAlign='center'; 
      ctx.fillText(currentLang === 'vi' ? 'B√ÅNH XE MAY M·∫ÆN' : 'LUCKY WHEEL', cx, cy+4);
      
      drawConfetti();
    }

    // Improved text wrapping function
    function wrapText(ctx, text, x, y, maxWidth, fontSize) {
      const words = text.split(' ');
      let line = '';
      let lineHeight = fontSize + 2;
      let lines = [];
      
      ctx.font = `bold ${fontSize}px "Press Start 2P", monospace`;
      
      for(let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        
        if (testWidth > maxWidth && n > 0) {
          lines.push(line);
          line = words[n] + ' ';
        } else {
          line = testLine;
        }
      }
      lines.push(line);
      
      // Draw all lines centered
      for(let i = 0; i < lines.length; i++) {
        ctx.fillText(lines[i].trim(), x, y + (i - (lines.length-1)/2) * lineHeight);
      }
    }

    // interactions
    spinBtn.addEventListener('click', ()=>{ const seed = seedInput.value || null; const power = parseFloat(spinPower.value)||2; startSpin(seed, power); if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); });
    pickOne.addEventListener('click', ()=>{ const s = seedInput.value || null; let rng = Math.random; if(s) rng = mulberry32(hashStringToInt(s)); const chosen = weightedPick(s? rng : Math.random); if(chosen){ displayWinner(chosen); } });
    pickMany.addEventListener('click', ()=>{ const n = Math.max(1, parseInt(pickCount.value)||1); const s = seedInput.value || null; let rng = Math.random; if(s){ rng = mulberry32(hashStringToInt(s)); } const winnersLocal = []; const temp = items.slice(); for(let i=0;i<n && temp.length>0;i++){ const total = temp.reduce((s,it)=> s + (Number(it.weight)||1),0); let x = (s? rng() : Math.random())*total; let chosen=null; for(const it of temp){ x -= (Number(it.weight)||1); if(x<=0){ chosen=it; break; } } if(!chosen) chosen = temp[temp.length-1]; winnersLocal.push(chosen); const idx = temp.findIndex(t=> t.id===chosen.id); if(idx>=0) temp.splice(idx,1); } for(const w of winnersLocal) displayWinner(w); if(removeOnPick.checked){ const wins = new Set(winnersLocal.map(w=>w.id)); removedStack.push(...items.filter(i=> wins.has(i.id))); items = items.filter(i=> !wins.has(i.id)); namesInput.value = items.map(i=> i.label + (i.weight && i.weight!==1 ? ';'+i.weight : '')).join('\n'); buildPreview(); saveTemp(); } });

    exportPNG.addEventListener('click', ()=>{ const data = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href=data; a.download='apex-wheel.png'; a.click(); });

    window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); spinBtn.click(); } });
    // Allow Enter newline; Ctrl/Cmd+Enter to parse
    namesInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); parseNames(); } });

    // click to slow/quick stop or start
    canvas.addEventListener('click', ()=>{ if(state.spinning) state.angularVelocity *= 0.2; else { const seed = seedInput.value || null; startSpin(seed, parseFloat(spinPower.value)||2); } });

    // drag-to-spin
    let dragging=false, startY=0, startAngle=0, velocitySamples=[], lastMoveTime=0;
    canvas.addEventListener('pointerdown', (e)=>{ canvas.setPointerCapture(e.pointerId); dragging=true; startY=e.clientY; startAngle=state.angle; velocitySamples=[]; lastMoveTime=performance.now(); });
    canvas.addEventListener('pointermove', (e)=>{ if(!dragging) return; const now=performance.now(); const dy = e.clientY - startY; state.angle = startAngle + dy*0.01; const dt = now - lastMoveTime; if(dt>10){ velocitySamples.push((dy)/(dt/1000)); if(velocitySamples.length>8) velocitySamples.shift(); lastMoveTime = now; } });
    canvas.addEventListener('pointerup', (e)=>{ if(!dragging) return; dragging=false; const avgV = velocitySamples.length? velocitySamples.reduce((s,v)=>s+v,0)/velocitySamples.length : 0; const power = parseFloat(spinPower.value)||2; state.angularVelocity = avgV*0.02 * (power*1.2); state.spinning=true; state.idle=false; state._onResult = function(){ const s = seedInput.value || null; let rng = Math.random; if(s) rng = mulberry32(hashStringToInt(s)); const chosen = weightedPickWithRng(rng); displayWinner(chosen); }; });

    // winners & posts rendering
    function renderWinners(){ winnersDiv.innerHTML=''; for(const w of winners){ const d=document.createElement('div'); d.className='chip'; d.textContent = `${new Date(w.ts).toLocaleString()} ‚Ä¢ ${w.label}`; winnersDiv.appendChild(d); } }
    loadWinners();

    function renderPosts(){ postsDiv.innerHTML=''; for(const p of posts){ const el=document.createElement('div'); el.className='post'; el.innerHTML = `<div style="font-size:12px;color:var(--muted)">${new Date(p.ts).toLocaleString()}</div><div style="font-weight:700">${p.title}</div>`; postsDiv.appendChild(el); } }
    loadPosts();

    clearHistoryBtn.addEventListener('click', ()=>{ if(confirm(i18n[currentLang]['confirmClearWinners'])){ winners=[]; saveWinners(); renderWinners(); }});
    undoRemoveBtn.addEventListener('click', ()=>{ if(removedStack.length===0){ alert(i18n[currentLang]['nothingToUndo']); return;} const last = removedStack.pop(); items.push(last); namesInput.value = items.map(i=> i.label + (i.weight && i.weight!==1 ? ';'+i.weight : '')).join('\n'); buildPreview(); saveTemp(); });

    // canvas sizing and init
    function resizeCanvas(size){ canvas.width = size; canvas.height = size; canvas.style.width = Math.min(760, window.innerWidth - 64) + 'px'; }
    resizeCanvas(state.size);
    window.addEventListener('resize', ()=> resizeCanvas(state.size));
    // load temp on start
    loadTemp();
    if(items.length===0){ 
      namesInput.value = 'Nguy·ªÖn VƒÉn A\nTr·∫ßn Th·ªã B;2\nL√™ VƒÉn C|3\nPh·∫°m Th·ªã D\nHo√†ng VƒÉn E\nƒê·ªó Th·ªã F;0.5'; 
      parseNames(); 
    }
    // load winners & posts already called

    // helper pick with provided rng
    function weightedPickWithRng(rng){ const total = items.reduce((s,it)=> s + (Number(it.weight)||1),0); if(total<=0) return null; let x = (typeof rng === 'function'? rng() : Math.random())*total; for(const it of items){ x -= (Number(it.weight)||1); if(x<=0) return it; } return items[items.length-1]; }

    // share/load from hash
    (function tryLoadFromHash(){ loadFromHash(); })();

    // audio resume on gesture
    document.addEventListener('click', ()=>{ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }, {once:true});

    // theme / pixel toggle
    themeToggle.addEventListener('click', ()=>{
      pixelMode = !pixelMode; document.body.classList.toggle('pixel-mode', pixelMode);
      darkTheme = !darkTheme; // simple demo: invert background
      if(darkTheme){ 
        document.documentElement.style.setProperty('--bg','#0a1929');
        document.documentElement.style.setProperty('--panel','#0f2438');
        document.documentElement.style.setProperty('--card','#132f44');
        document.documentElement.style.setProperty('--accent','#4fc4f7');
        document.documentElement.style.setProperty('--muted','#a6b3c5');
      } else { 
        document.documentElement.style.setProperty('--bg','#f5f8fb');
        document.documentElement.style.setProperty('--panel','#e1e8f0');
        document.documentElement.style.setProperty('--card','#d4e1f0');
        document.documentElement.style.setProperty('--accent','#1a73e8');
        document.documentElement.style.setProperty('--muted','#5f6368');
      }
    });

    // initial draw
    requestAnimationFrame(draw);

  })();
  </script>
</body>
</html>